<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Accessing AppSync API DynomoDB Tables from Amplify Lambda Functions - Simon&#39;s blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="Accessing AppSync API DynomoDB Tables from Amplify Lambda Functions" />
<meta property="og:description" content="Amplify offers the ability to add lambda functions which use other configured resources including DynomoDB Tables" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ziggy6792.github.io/posts/amplify-lambda-dynomodb/" />
<meta property="article:published_time" content="2019-08-23T09:07:48+07:00" />
<meta property="article:modified_time" content="2019-08-23T09:07:48+07:00" />

	<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Accessing AppSync API DynomoDB Tables from Amplify Lambda Functions"/>
<meta name="twitter:description" content="Amplify offers the ability to add lambda functions which use other configured resources including DynomoDB Tables"/>

	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Simon&#39;s blog" rel="home">
				<div class="logo__title">Simon&#39;s blog</div>
				<div class="logo__tagline">Personal tech blog </div>
			</a>
		</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Accessing AppSync API DynomoDB Tables from Amplify Lambda Functions</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2019-08-23T09:07:48&#43;07:00">August 23, 2019</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/web-development/" rel="category">Web Development</a>
	</span>
</div></div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#pre-requisites">Pre-requisites</a></li>
    <li><a href="#creating-a-lambda-function-with-amplify-cli">Creating a Lambda function with Amplify CLI</a></li>
    <li><a href="#potential-maximum-policy-size-issue-when-running-amplify-push">Potential maximum policy size issue when running amplify push</a>
      <ul>
        <li><a href="#option1-reducing-the-number-of-tables-added-to-the-role-policy">Option1: Reducing the number of tables added to the role policy</a></li>
        <li><a href="#option2-customizing-local-cloud-formation-template-generated-by-amplify">Option2: Customizing local cloud formation template generated by Amplify</a></li>
      </ul>
    </li>
    <li><a href="#modify-cloud-formation-template-to-give-access-to-all-amplify-api-tables">Modify cloud formation template to give access to all Amplify API tables</a></li>
    <li><a href="#test-your-new-function-write-to-dynomodb-from-lambda-function">Test your new function. Write to DynomoDB from Lambda Function</a></li>
  </ul>
</nav>
	</div>
</div>
<div class="content post__content clearfix">
			<h2 id="introduction">Introduction</h2>
<p>This article will focus on creating a lambda function with the Amplify CLI that has access to the <a href="https://docs.amplify.aws/cli/graphql-transformer/directives#model">@model</a> DynomoDB tables setup for an <a href="https://docs.amplify.aws/lib/graphqlapi/getting-started/q/platform/js">Amplify AppSync API</a>.</p>
<p><strong>WHY</strong></p>
<ul>
<li>Perhaps you want to write some custom graphQL <a href="https://docs.amplify.aws/cli/graphql-transformer/directives#function">@function</a> resolvers that interact with your API DynomoDB tables directly (e.g. add a batch of items to a table)</li>
<li>Or, set up triggers on your tables (e.g. to cascade deletes to orphaned items)</li>
</ul>
<h2 id="pre-requisites">Pre-requisites</h2>
<ul>
<li>Install Amplify CLI (version 4.16.1 or higher)</li>
<li>Run Amplify Init</li>
<li>Create GraphQL API</li>
</ul>
<h2 id="creating-a-lambda-function-with-amplify-cli">Creating a Lambda function with Amplify CLI</h2>
<p>Use the following commands to create a Lambda function with Amplify CLI. After selecting the category storage you will be prompted to select the <a href="https://docs.amplify.aws/cli/graphql-transformer/directives#model">@model</a> DynomoDB tables setup by <a href="https://docs.amplify.aws/lib/graphqlapi/getting-started/q/platform/js">amplify add api</a>.<br>
<strong>NOTE</strong>: You will need Amplify CLI version 4.16.1 or higher.</p>
<script type="application/javascript" src="https://gist.github.com/ziggy6792/f8ea26516f51fbb7bf2ee024f9d054f0.js?file=createLambdaFunction.txt"></script>

<h2 id="potential-maximum-policy-size-issue-when-running-amplify-push">Potential maximum policy size issue when running amplify push</h2>
<p>When running amplify push at the end of the last step you may see the following <a href="https://github.com/aws-amplify/amplify-cli/issues/1699">issue</a>.
&ldquo;Maximum policy size of 10240 bytes exceeded for role &lt;apiName&gt;LambdaRole26741da9-&lt;apiName&gt;&rdquo;</p>
<p>This issue occurs when the policy created by for the lambda role (the IAM role created to run your new lambda function) exceeds the maximum size allowed for role inline policies.</p>
<h3 id="option1-reducing-the-number-of-tables-added-to-the-role-policy">Option1: Reducing the number of tables added to the role policy</h3>
<p>If possible you should reduce the tables and actions granted in the precious step (following the best practice that each lambda only has access to the actions and recourses it expressly needs). However, this may not be possible. In my case, I wanted to write a lambda function that cascaded deletes through my table schema. Therefore, my lambda function needs to have access to all of my API tables.</p>
<h3 id="option2-customizing-local-cloud-formation-template-generated-by-amplify">Option2: Customizing local cloud formation template generated by Amplify</h3>
<p>To understand a work around for this issue, it is important to explain in more detail what amplify add function is actually doing. Amplify add function creates a local folder for the function containing a cloud formation template. E.g;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">amplify</span><span style="color:#f92672">/</span><span style="color:#a6e22e">backend</span><span style="color:#f92672">/</span><span style="color:#a6e22e">function</span><span style="color:#f92672">/</span><span style="color:#a6e22e">doSomethingToDBTables</span><span style="color:#f92672">/</span><span style="color:#a6e22e">doSomethingToDBTables</span><span style="color:#f92672">-</span><span style="color:#a6e22e">cloudformation</span><span style="color:#f92672">-</span><span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">json</span></code></pre></div>
<p>This template describes the lambda to be created when amplify push is next run. However, Amplify is not very clever when it comes to creating the templates which create role inline policies. The amplify created cloud formation template creates a separate inline policy statement for each DynomoDB table (even if the allowed actions are the same).</p>
<p>For example; granting these actions;</p>
<ul>
<li>&ldquo;dynamodb:Put*&quot;,</li>
<li>&ldquo;dynamodb:Create*&quot;,</li>
<li>&ldquo;dynamodb:BatchWriteItem&rdquo;,</li>
<li>&ldquo;dynamodb:Get*&quot;,</li>
<li>&ldquo;dynamodb:BatchGetItem&rdquo;,</li>
<li>&ldquo;dynamodb:List*&quot;,</li>
<li>&ldquo;dynamodb:Describe*&quot;,</li>
<li>&ldquo;dynamodb:Scan&rdquo;,</li>
<li>&ldquo;dynamodb:Query&rdquo;,</li>
<li>&ldquo;dynamodb:Update*&quot;,</li>
<li>&ldquo;dynamodb:RestoreTable*&quot;,</li>
<li>&ldquo;dynamodb:Delete*&rdquo;</li>
</ul>
<p>To these tables;</p>
<ul>
<li>Competition-xl3qodhqsfdmhe5psj4vqa7wsy-compapi</li>
<li>User-xl3qodhqsfdmhe5psj4vqa7wsy-compapi</li>
<li>Event-xl3qodhqsfdmhe5psj4vqa7wsy-compapi</li>
<li>Heat-xl3qodhqsfdmhe5psj4vqa7wsy-compapi</li>
<li>RiderAllocation-xl3qodhqsfdmhe5psj4vqa7wsy-compapi</li>
<li>SeedSlot-xl3qodhqsfdmhe5psj4vqa7wsy-compapi</li>
</ul>
<p>Will create the following access policy list of statements;</p>
<script type="application/javascript" src="https://gist.github.com/ziggy6792/f8ea26516f51fbb7bf2ee024f9d054f0.js?file=accessPolicyExample1.json"></script>

<p>Which is actually equivalent to the following single statement (which uses pattern recourse descriptions instead);</p>
<script type="application/javascript" src="https://gist.github.com/ziggy6792/f8ea26516f51fbb7bf2ee024f9d054f0.js?file=accessPolicyExample2.json"></script>

<p>The difference with using the second example however is that; generating policies this way will not cause policies to grow in size with the number of API tables and therefore will not easily hit the maximum policy size and cause the maximum policy size issue.</p>
<p>Therefore, a workaround for the maximum policy size issue is to modify your cloud formation template to consolidate the assignment of actions to tables. Exactly how to modify the cloud formation template will depend on the specific access rights you want to grant to your lambda. A common example however would be if you wanted to grant the same access to all API tables.</p>
<h2 id="modify-cloud-formation-template-to-give-access-to-all-amplify-api-tables">Modify cloud formation template to give access to all Amplify API tables</h2>
<p>The following steps show how you can grant access to all Amplify API tables and avoid the maximum policy size issue.</p>
<p>I have created the following shell script to help with this common example.</p>
<p>Running this script will remove all but one access policy statements from the lambda function role.</p>
<script type="application/javascript" src="https://gist.github.com/ziggy6792/f8ea26516f51fbb7bf2ee024f9d054f0.js?file=reduceLambdaAccessPolicySize.sh"></script>

<p>You can run this shell script and enter the path to your lambda cloud formation template as shown below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">NBMAC0056</span>:<span style="color:#a6e22e">SwtNinja</span> <span style="color:#a6e22e">verhoeven</span><span style="color:#960050;background-color:#1e0010">\$</span> . <span style="color:#a6e22e">amplify</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bash</span><span style="color:#f92672">/</span><span style="color:#a6e22e">reduceLambdaAccessPolicySize</span>.<span style="color:#a6e22e">sh</span>
<span style="color:#a6e22e">Path</span> <span style="color:#a6e22e">To</span> <span style="color:#a6e22e">Cloud</span> <span style="color:#a6e22e">Formation</span> <span style="color:#a6e22e">Template</span>:<span style="color:#a6e22e">amplify</span><span style="color:#f92672">/</span><span style="color:#a6e22e">backend</span><span style="color:#f92672">/</span><span style="color:#a6e22e">function</span><span style="color:#f92672">/</span><span style="color:#a6e22e">doSomethingToDBTables</span><span style="color:#f92672">/</span><span style="color:#a6e22e">doSomethingToDBTables</span><span style="color:#f92672">-</span><span style="color:#a6e22e">cloudformation</span><span style="color:#f92672">-</span><span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">json</span></code></pre></div>
<p>This will create a file &ldquo;output-cloudformation-template.json&rdquo; in the same directory as the shell script. Copy and replace the entire contents of this file into your Lambda function local cloud formation template.</p>
<p>Now manually edit the template to give access to all api tables by using a pattern resource definition (&quot;*-ApiName-EnvName&rdquo;).</p>
<p>In your new cloud formation template, make the following changes;</p>
<script type="application/javascript" src="https://gist.github.com/ziggy6792/f8ea26516f51fbb7bf2ee024f9d054f0.js?file=editCloudFormationTemplate.diff"></script>

<p><a href="https://gist.github.com/ziggy6792/f8ea26516f51fbb7bf2ee024f9d054f0#file-dosomethingtodbtables-cloudformation-template-json">Here</a> is an example of my final cloud formation template ready to be pushed using amplify push.</p>
<p>Next run amplify push.</p>
<p>Go to your ec2 console. You should see the following created lambda function;</p>
<figure>
    <img src="/img/posts/Accessing_DynomoDB_Tables/Created-Function.png"/> <figcaption>
            <h4>Created Lambda Function</h4>
        </figcaption>
</figure>

<p>Along with the following attached role and access policy.</p>
<figure>
    <img src="/img/posts/Accessing_DynomoDB_Tables/Created-Role.png"/> <figcaption>
            <h4>Created Role</h4>
        </figcaption>
</figure>

<h2 id="test-your-new-function-write-to-dynomodb-from-lambda-function">Test your new function. Write to DynomoDB from Lambda Function</h2>
<p>To test access to dynomoDB from your new Lambda function copy the following code into your local lambda function index.js.</p>
<script type="application/javascript" src="https://gist.github.com/ziggy6792/f8ea26516f51fbb7bf2ee024f9d054f0.js?file=lambda-function-index.js"></script>

<p><strong>IMPORTANT</strong>:</p>
<ul>
<li>Do not replace the Amplify Params, keep your own</li>
<li>Replace tableName (line 33) with one of your own resource attributes as environment variables that was created here <a href="/posts/amplify-lambda-dynomodb/#creating-a-lambda-function-with-amplify-cli">here</a></li>
<li>You will also need to cd to you local lambda function directory and install npm package uuid</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#a6e22e">NBMAC0056</span>:<span style="color:#a6e22e">SwtNinja</span> <span style="color:#a6e22e">verhoeven</span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">cd</span> <span style="color:#e6db74">&#34;amplify/backend/function/doSomethingToDBTables/src/&#34;</span>
<span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#a6e22e">NBMAC0056</span>:<span style="color:#a6e22e">src</span> <span style="color:#a6e22e">verhoeven</span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">npm</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">save</span> <span style="color:#a6e22e">uuid</span></span></code></pre></div>
<p>Next run amplify push</p>
<p>Now you can test your function in the AWS console;</p>
<figure>
    <img src="/img/posts/Accessing_DynomoDB_Tables/Test-Function.png"/> <figcaption>
            <h4>Test Function</h4>
        </figcaption>
</figure>

<p>And then verify that an item was created in the specified table;</p>
<figure>
    <img src="/img/posts/Accessing_DynomoDB_Tables/Test-Function-Created-Item.png"/> <figcaption>
            <h4>Test Function Success - Created Item</h4>
        </figcaption>
</figure>

<!-- raw HTML omitted -->

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/aws/" rel="tag">AWS</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/amplify/" rel="tag">Amplify</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/dynomodb/" rel="tag">DynomoDB</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/lambda/" rel="tag">Lambda</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/cloud-formation/" rel="tag">Cloud Formation</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

    <div class="authorbox clearfix">
      <figure class="authorbox__avatar">
        <img alt="Simon Verhoeven avatar" src="/img/authors/simon-verhoeven.png" class="avatar" height="90" width="90">
      </figure>
      <div class="authorbox__header">
        <span class="authorbox__name">
          About Simon Verhoeven
        </span>
      </div>
      <div class="authorbox__description">
        Senior Architect, 7&#43; years working in IT industry, interested in Javascript | React | Full Stack Web-development
      </div>
    </div>





			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Mofos Engineering Ltd.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>